# CICost 强化技术文档 v2.0

```text
项目名称：CICost
阶段：Post-v0.1.0 强化版（v0.2.0 / v0.3.0）
日期：2026-02-26
目标：从“可用”升级到“可信 + 可治理 + 可规模化”
```

---

## 0. 一句话定位（Positioning）

```text
CICost v2：把 GitHub Actions 成本分析升级为“可校准（Reconciled）+ 可门禁（Policy Gate）+ 可执行修复（Auto Fix Suggestion）”的 CI FinOps CLI。
```

关键词（Key Terms）：

- Reconciliation（对账校准）：估算值与真实账单比对并修正误差
- Policy Gate（策略门禁）：超预算/高浪费时阻断 PR 或流水线
- Confidence Band（置信区间）：估算值可信范围
- What-if Simulation（情景模拟）：迁移 runner 或优化策略的节省预测

---

## 1. 强化目标（Goals）与非目标（Non-goals）

```text
Goals
├─ G1: 成本精度提升（Pricing v2 + 对账）
├─ G2: 治理能力提升（Policy-as-Code + CI Gate）
├─ G3: 可执行优化提升（自动建议 + YAML patch）
└─ G4: 组织级可用（多仓聚合 + 趋势告警）

Non-goals
├─ N1: 暂不做 Web Dashboard（CLI-first 继续）
├─ N2: 暂不做复杂权限系统（先复用 GitHub token scope）
└─ N3: 暂不做全量 APM 观测替代（保持 CI FinOps 专注）
```

---

## 2. 竞品对比与定位（Competitive Positioning）

```text
[GitHub Native Billing]
     | 账单真实但解释弱
     v
[CICost v2]
     | 成本解释 + 浪费定位 + 策略门禁 + 修复建议
     v
[Runner Vendors / Observability]
  提供算力优化或深度观测，CICost负责“决策层与治理层”
```

差异化方向：

1. 相比原生账单：提供可执行建议（actionable insights）。
2. 相比 Runner 厂商：提供跨 runner 的中立评估与 ROI 模拟。
3. 相比通用观测平台：提供轻量 CLI + PR 门禁 + 成本策略。

---

## 3. 架构升级（Architecture Upgrade）

### 3.1 v2 架构图（ASCII）

```text
┌─────────────────────────────────────────────┐
│                User / CI Pipeline            │
│      cicost scan/report/reconcile/policy     │
└──────────────────────┬──────────────────────┘
                       │
                       v
┌─────────────────────────────────────────────┐
│                Command Layer                 │
│ init | scan | report | budget | policy check│
└───────────────┬───────────────┬────────────┘
                │               │
                v               v
      ┌────────────────┐  ┌──────────────────┐
      │ Data Ingestion │  │ Config/Policy     │
      │ Runs/Jobs/Bill │  │ .cicost.yml/.policy.yml │
      └──────┬─────────┘  └──────────┬───────┘
             │                       │
             v                       v
      ┌──────────────────────────────────────┐
      │      SQLite + Snapshot Storage       │
      │ runs/jobs/billing/reconcile/policies │
      └──────────────────┬───────────────────┘
                         │
                         v
      ┌──────────────────────────────────────┐
      │         Analytics + Policy Engine    │
      │ cost/waste/hotspot/reconcile/gating  │
      └──────────────────┬───────────────────┘
                         │
                         v
      ┌──────────────────────────────────────┐
      │ Output: table/md/json/csv/pr-comment │
      └──────────────────────────────────────┘
```

### 3.2 新增模块

- `internal/reconcile`：估算 vs 实际对账
- `internal/policy`：策略解析与判定
- `internal/suggest`：修复建议与 YAML patch
- `internal/billing`：账单端点/导入适配器

---

## 4. 功能增强设计（Feature Enhancements）

### 4.1 Pricing v2（SKU 定价模型）

```text
旧模型：linux单价 + OS乘数
新模型：按 runner SKU 明确定价 + 生效日期版本化
```

要点：

1. `configs/pricing_default.yml` 增加 `effective_from` 与 `skus`。
2. 计算链路从 `os multiplier` 切换到 `sku direct rate`。
3. 报告中输出 `pricing_snapshot_version + effective_date`。

### 4.2 Reconciliation（账单对账）

命令草案：

- `cicost reconcile --repo owner/repo --month 2026-02`
- `cicost report --calibrated`

输出：

- 估算值（estimate）
- 实际值（actual）
- 偏差率（delta%）
- 校准系数（calibration factor）
- 置信等级（confidence: high/medium/low）

### 4.3 Policy Gate（策略门禁）

新增配置文件：`.cicost.policy.yml`

```yaml
rules:
  - id: budget_monthly
    when: monthly_cost_usd > 200
    severity: error
  - id: waste_ratio
    when: waste_percentage > 25
    severity: warn
actions:
  on_error: fail_ci
  on_warn: comment_pr
```

新增命令：

- `cicost policy check --repo owner/repo --days 30`

### 4.4 Auto Fix Suggestion（自动修复建议）

输出可执行 patch 模板：

1. `concurrency.cancel-in-progress` patch
2. dependency cache patch
3. paths filter patch
4. runner migration patch（例如 macOS -> Linux）

---

## 5. 数据模型升级（Schema v2）

新增表：

1. `billing_snapshots`
2. `reconcile_results`
3. `policy_runs`
4. `suggestion_history`

示意：

```sql
CREATE TABLE billing_snapshots (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  repo TEXT NOT NULL,
  period TEXT NOT NULL,
  actual_cost_usd REAL NOT NULL,
  source TEXT NOT NULL,
  fetched_at TEXT NOT NULL DEFAULT (datetime('now'))
);

CREATE TABLE reconcile_results (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  repo TEXT NOT NULL,
  period TEXT NOT NULL,
  estimated_cost_usd REAL NOT NULL,
  actual_cost_usd REAL NOT NULL,
  delta_ratio REAL NOT NULL,
  calibration_factor REAL NOT NULL,
  confidence TEXT NOT NULL,
  created_at TEXT NOT NULL DEFAULT (datetime('now'))
);
```

---

## 6. 命令扩展（Command Expansion）

```text
cicost
├─ reconcile
│  ├─ --repo owner/repo
│  ├─ --month YYYY-MM
│  ├─ --source github|csv
│  └─ --apply-calibration
├─ policy
│  ├─ check
│  ├─ lint
│  └─ explain
├─ suggest
│  ├─ --repo owner/repo
│  ├─ --format text|yaml
│  └─ --output patches/
└─ org-report
   ├─ --repos file.txt
   ├─ --days 30
   └─ --format md|json
```

---

## 7. 验收标准（Detailed Acceptance Criteria）

## 7.1 Pricing v2 验收

### AC-PRICING-01：SKU 计算正确

验证：

1. 同一 Job 在不同 SKU 下按对应单价计算。
2. 不再依赖 OS 乘数兜底（仅兼容旧配置时提示 warning）。
3. 报告包含 `pricing_snapshot_version` 与 `effective_from`。

### AC-PRICING-02：版本切换正确

验证：

1. 指定历史周期时自动命中当期定价版本。
2. 版本缺失时返回明确错误与修复建议。
3. JSON 输出记录 `pricing_source`。

## 7.2 Reconcile 验收

### AC-REC-01：对账计算正确

验证：

1. `delta_ratio = (estimate-actual)/actual`。
2. `calibration_factor` 正确应用到后续报告（`--calibrated`）。
3. 对账结果写入 `reconcile_results`。

### AC-REC-02：置信度分级

验证：

1. `|delta| <= 5%` -> `high`
2. `5% < |delta| <= 15%` -> `medium`
3. `|delta| > 15%` -> `low`

## 7.3 Policy Gate 验收

### AC-POL-01：规则判定

验证：

1. 支持 `error/warn/info` 三档。
2. 表达式解析失败时 `policy lint` 返回非 0。
3. `policy check` 输出命中规则列表与证据值。

### AC-POL-02：CI 行为

验证：

1. 命中 `error` -> exit code `3`（新增）。
2. 仅命中 `warn` -> exit code `0`，但输出警告并可 PR 评论。
3. 写入 `policy_runs` 审计表。

## 7.4 Suggestion 验收

### AC-SUG-01：建议可执行

验证：

1. 每条建议包含 `问题 -> 当前数据 -> 预计收益 -> 修复片段`。
2. 至少覆盖 3 类策略（并发、缓存、paths）。
3. `--format yaml` 输出可直接复制进 workflow。

### AC-SUG-02：建议可信

验证：

1. 无数据支撑的建议不输出。
2. 每条建议附带证据字段（job/workflow/fail_rate/cost）。

## 7.5 Org-Report 验收

### AC-ORG-01：多仓聚合

验证：

1. 支持 N 仓并行聚合（N>=20）。
2. 输出总成本、前 10 热区、仓库排名。
3. 单仓失败不影响整体（partial result）。

### AC-ORG-02：性能

验证：

1. 20 仓、总 5000 runs：报告生成 < 60s。
2. 峰值内存 < 500MB。

---

## 8. 工程质量与测试门禁（Test Gate）

```text
Validation Flow
├─ Red: 先定义失败样例（pricing/reconcile/policy）
├─ Green: 最小实现通过用例
└─ Refactor: 重构后回归（unit + integration + race）
```

必须通过：

1. `go test ./...`
2. `go test -race ./...`
3. `go vet ./...`
4. `policy lint` fixture tests
5. `reconcile` fixture integration tests

---

## 9. 风险分级测试矩阵（Risk-Based Test Matrix）

```text
[New Change]
    |
    v
[Risk Tier L/M/H]
    |--------------|--------------|
    v              v              v
[L] 文档/小改   [M] 常规功能    [H] 策略/账单/门禁
    |              |              |
    v              v              v
smoke            unit+int        full+race+security
```

规则：

1. `L`：仅文档/文案/无逻辑改动。
2. `M`：常规功能（默认）。
3. `H`：策略门禁、对账、计费口径、CI 阻断行为。

---

## 10. 里程碑（Roadmap）

```text
Sprint A (v0.2.0)
├─ Pricing v2
├─ Reconcile v1
└─ Policy check v1

Sprint B (v0.2.x)
├─ Suggestion patch export
├─ PR comment integration
└─ Org report beta

Sprint C (v0.3.0)
├─ Calibration feedback loop
├─ Advanced anomaly detection
└─ Optional lightweight web report export
```

---

## 11. 发布与回滚策略（Release & Rollback）

发布门槛：

1. 所有 `H` 级改动必须有回滚开关。
2. `policy check` 新规则默认 `warn`，灰度后再 `error`。
3. 对账与校准默认 `opt-in`。

回滚策略：

1. `pricing_v2_enabled=false`
2. `policy_gate_enabled=false`
3. `reconcile_enabled=false`

---

## 12. v2 验收总清单（Done Definition）

```text
Done Definition
├─ 功能：Pricing v2 + Reconcile + Policy + Suggestion 可用
├─ 质量：测试门禁全通过
├─ 文档：README/RUNBOOK/CHANGELOG 更新
├─ 发布：tag release + artifacts + checksums
└─ 运营：至少 3 个真实仓库验证并可复现
```

